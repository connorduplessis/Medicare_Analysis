---
title: "Medicare Provider Summary for the Top 100 Diagnosis-Related Groups (DRG)"
author: "Connor Duplessis"
date: "12/6/2017"
output: rmarkdown::github_document
---
## Introduction

The dataset includes hospital-specific charges for the more than 3,000 U.S. hospitals that receive Medicare Inpatient Prospective Payment System (IPPS) payments for the top 100 most frequently billed discharges, paid under Medicare based on a rate per discharge using the Medicare Severity Diagnosis Related Group (MS-DRG) for Fiscal Year (FY) 2011. These DRGs represent more than 7 million discharges or 60 percent of total Medicare IPPS discharges.The dataset includes 12 variables across 163,065 observations.

The goals of this report are to determine:  
Which states on average charge the most and least amounts across all DRG's  
If a states population is a good indicator of how much providers charge  
If certain area's of the country are more expensive than others  

Dataset URL: https://data.cms.gov/Medicare-Inpatient/Inpatient-Prospective-Payment-System-IPPS-Provider/97k6-zzx3 

    
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing and Cleaning
```{r message = FALSE}
IPPS <- read.csv("IPPS.csv", stringsAsFactors=FALSE)  
library(dplyr)
library(magrittr)
```
We are only going to be looking at a few columns, so I will remove all the unnecessary columns.
```{r}
IPPS3 <- IPPS[,-c(2:5, 7:9, 11:12)]
head(IPPS3)
```


We also need to remove the Dollar Signs from the Average.Covered.Charges Column before starting the analysis
```{r}
DollarSignRemoved <- gsub('$', '', IPPS3$Average.Covered.Charges, fixed = TRUE)
DollarSignRemoved <- as.numeric(DollarSignRemoved)
IPPS4<- IPPS3[,-3]
IPPS4[,"Average.Covered.Charges"] <- DollarSignRemoved
head(IPPS4)
```

##State Rankings    
To determine how states compare against each other on average, we are going to rank them 1-51 (Washington DC is included) for every DRG. Because this dataset contains the top 100 most common DRG's we will have 100 sets of rankings that we can determine each state's average ranking across all DRG's.



```{r}
StateAverage <- IPPS4 %>%
  group_by(Provider.State, DRG.Definition) %>%
  mutate(Average = mean(Average.Covered.Charges)) %>%
  distinct(DRG.Definition, Provider.State, .keep_all = TRUE) %>%
  arrange(DRG.Definition, desc(Average))
StateAverage2 <- StateAverage %>%
  group_by(DRG.Definition) %>%
  mutate(DRGRank = rank(Average))
StateRank <- StateAverage2 %>%
  group_by(Provider.State) %>%
  mutate(AverageDRGRank = mean(DRGRank)) %>%
  distinct(AverageDRGRank, .keep_all = TRUE) %>%
  arrange(desc(AverageDRGRank)) %>%
  select(Provider.State, AverageDRGRank)

print(StateRank, n = 51)
```


From this calculation we can see that providers in California on average charge the highest amounts while providers in Maryland charge the least. It seems like the highly populated states fall on the more expensive side of the rankings. Could state population be correlated with how much a provider charges? Let's take a look.  

##Population vs. Rankings

I pulled state population data from https://en.wikipedia.org/wiki/List_of_U.S._states_and_territories_by_population

```{r}
library(readxl)
State_Population <- read_excel("State_Population.xls", col_names = FALSE)
head(State_Population)
```

We'll need to do some cleaning and manipulating in StateRank before we can join in the population numbers; such as: removing Washington DC, converting State abbreviations into full State names, and ordering alphabetically.

```{r}
library(datasets)
StateRankandPop <- StateRank[-10,]

StateNames <- state.name[match(StateRankandPop$Provider.State,state.abb)]

StateRankandPop[,"StateName"] <- StateNames

StateRankandPop <- StateRankandPop  %>%
  arrange(StateName)

head(StateRankandPop)
```

Now we can join in the population numbers

```{r}
StateRankandPop[,"Population"] <- State_Population$X__2
head(StateRankandPop)
```

Now let's plot population against the State's rankings we calculated.

```{r}
library(ggplot2)
PopVsDRGRank <- ggplot(StateRankandPop, aes(x = AverageDRGRank, y = Population)) +
  geom_point() +
  geom_smooth(method = "lm")

PopVsDRGRank
```

There seems to be a slight positive correlation between these 2 variables but more analysis would need to be done. What about certain regions of the country being more or less expensive than others? Let's take a look.  

##State Map

```{r}
library(maps)
library(mapproj)
library(mapdata)
library(fiftystater)

StateAverageForMap <- StateRankandPop[,-c(1,4)]

StateNameLower <- tolower(StateAverageForMap$StateName)

StateAverageForMap[,"State"] <- StateNameLower

StateAverageForMap <- StateAverageForMap[,-2]

StateMap <- ggplot(StateAverageForMap, aes(map_id = State)) +
geom_map(aes(fill = AverageDRGRank), map = fifty_states) +
expand_limits(x = fifty_states$long, y = fifty_states$lat) +
coord_map() +
scale_x_continuous(breaks = NULL) +
scale_y_continuous(breaks = NULL) +
labs(x = "", y = "") +
theme(legend.position = "bottom",
panel.background = element_blank())

StateMap
```

From this map it doesn't appear that any particular region of the country is more or less expensive than others.

##Conclusion  
From this analysis, it appears that state population might be correlated with how much a provider charges. The state map shows that no region is more or less expensive than the rest of the country. Further analysis should be done to explore the data on the city or zip code level.