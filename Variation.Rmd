---
title: "Variation in Medicare Claims"
author: "Connor Duplessis"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This report will focus on quantifying the variability of charges across states and DRG Definitions.

###Read in dataset

```{r message =FALSE}
library(tidyverse)
library(kableExtra)
library(knitr)

IPPS <- read_csv("~/Desktop/Connor/Medicare_Analysis/IPPS.csv", 
                 col_types = cols(`Average Covered Charges` = col_number(), 
                                  `Average Medicare Payments` = col_number(), 
                                  `Average Total Payments` = col_number()))
glimpse(IPPS)
```

###Variation Statistics on DRG's  
Here we will calculate the Standard Deviation, Inner Quartile Range (IQR), Mean, and Median of all DRG's across all states.

```{r}
DRGVariation <- IPPS %>%
  group_by(`DRG Definition`) %>%
  mutate(SD = sd(`Average Covered Charges`)) %>%
  mutate(IQR = IQR(`Average Covered Charges`)) %>%
  mutate(Mean = mean(`Average Covered Charges`)) %>%
  mutate(Median = median(`Average Covered Charges`)) %>%
  distinct(`DRG Definition`, .keep_all = TRUE) %>%
  arrange(desc(SD)) %>%
  select(`DRG Definition`, `Mean`, `SD`, `IQR`, `Median`)

#10 highest standard deviation#
kable(DRGVariation[1:10,], "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 11) %>%
  scroll_box(width = "100%", height = "200px")  


#10 lowest standard deviation#
kable(arrange(tail(DRGVariation, n = 10),SD),"html") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 11) %>%
  scroll_box(width = "100%", height = "200px")  
```  

Here we see that the DRG 870- Septicemia has the highest standard deviation at $90,553, while DRG 310- Cardiac Arrhythmia has the lowest at $8,222. 

###Variation Statistics on DRG's by State  

Let's see which DRG's have the highest and lowest standard deviation when broken out for each state.  
```{r}
Variation_by_State <- IPPS %>%
  group_by(`DRG Definition`, `Provider State`) %>%
  mutate(SD = sd(`Average Covered Charges`)) %>%
  mutate(IQR = IQR(`Average Covered Charges`)) %>%
  mutate(Mean = mean(`Average Covered Charges`)) %>%
  mutate(Median = median(`Average Covered Charges`)) %>%
  distinct(`DRG Definition`, `Provider State`, .keep_all = TRUE) %>%
  arrange(desc(SD)) %>%
  select(`DRG Definition`, `Provider State`, `Mean`, `SD`, `IQR`, `Median`, `Total Discharges`)

#10 highest standard deviation#
kable(Variation_by_State[1:10,], "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 11) %>%
  scroll_box(width = "100%", height = "200px")  

#10 lowest standard deviation#
kable(arrange(tail(Variation_by_State, n = 10),SD),"html") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 11) %>%
  scroll_box(width = "100%", height = "200px")  
```
In this subset of the data we see even more variability. Respitory System Diagnosis (DRG 207) in California comes in with the highest standard deviation of $132,991. There are also standard deviations of zero and NA. These observations represent State's that only had one facility submit claims for that DRG. Let's coerce all the NA's to zeros. 

```{r}
# Coerce NA's on SD and IQR to 0 #
Variation_by_State[is.na(Variation_by_State)] <- 0
```

### Standard deviation against mean, IQR against median
Let's see how correlated standard deviation is to the mean and IQR to the median.

```{r}
# Plot SD against mean #
Mean_SD <- ggplot(Variation_by_State, aes(x = Mean, y = SD)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm")
Mean_SD

# Compute correlation between mean and Standard Deviation #
cor(Variation_by_State$Mean, Variation_by_State$SD)


# Plot IQR against median #
Median_IQR <- ggplot(Variation_by_State, aes(x = Median, y = IQR)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm")
Median_IQR

# Compute correlation between median and IQR #
cor(Variation_by_State$Median, Variation_by_State$IQR)
```

Here, we can see that standard deviation is highly correlated to the mean as well as IQR to the median. To adjust for this effect, let's calculate the coefficient of variation to determine which State/DRG combination's have the highest standard deviation as a percentage of the mean.

```{r}
# Add coefficient of variation to Variation_by_State #
Variation_by_State2 <- Variation_by_State %>%
  mutate(CV = (SD/Mean) *100) %>%
  select(`DRG Definition`, CV) %>%
  arrange(desc(CV))

kable(Variation_by_State2[1:10,],"html") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 11) %>%
  scroll_box(width = "100%", height = "200px")  
```

Here we can see that the highest coefficient of variation is Other Kidney & Urinary Tract Diagnoses in Alabama at 87.44. In other words, the standard deviation is roughly 87% of the mean charge.  
Could the number of discharges for a DRG be correlated with it's standard deviation? Let's see.
```{r}
Discharges_SD <- ggplot(Variation_by_State, aes(x = `Total Discharges`, y = `SD`)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm")
Discharges_SD
cor(Variation_by_State$`Total Discharges`, Variation_by_State$SD)
```

It appears that the number of discharges is not correlated with the standard deviation.